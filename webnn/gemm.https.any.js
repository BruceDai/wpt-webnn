// META: title=test WebNN API gemm operation
// META: global=window,dedicatedworker
// META: script=./resources/utils.js
// META: timeout=long

'use strict';

// https://webmachinelearning.github.io/webnn/#api-mlgraphbuilder-gemm

let context;
let builder;

async function testGemm(syncFlag, A, B, expected, C = undefined, options = {}) {
  const a = builder.input('a', {type: 'float32', dimensions: A.shape});
  const b = builder.constant(
      {type: 'float32', dimensions: B.shape}, new Float32Array(B.data));

  if (C !== undefined) {
    if (typeof C === 'number') {
      options.c = builder.constant(C);
    } else {
      options.c = builder.constant(
          {type: 'float32', dimensions: C.shape}, new Float32Array(C.data));
    }
  }

  const c = builder.gemm(a, b, options);
  const inputs = {'a': new Float32Array(A.data)};
  const outputs = {'c': new Float32Array(sizeOfShape(expected.shape))};
  let graph;

  if (syncFlag) {
    graph = builder.build({c});
    context.compute(graph, inputs, outputs);
  } else {
    graph = await builder.buildAsync({c});
    await context.computeAsync(graph, inputs, outputs);
  }

  assert_array_approx_equals_ulp(outputs.c, expected.data, ULPTolerance.float32.gemm, 'float32');
}

ExecutionArray.forEach(executionType => {
  const isSync = executionType === 'sync';
  if (self.GLOBAL.isWindow() && isSync) {
    return;
  }

  const targetDeviceTypeArray = getTargetDeviceTypeArray();
  targetDeviceTypeArray.forEach(deviceType => {
    promise_setup(async () => {
      await navigator.ml.createContext({deviceType}).then((ret) => context = ret);
      builder = new MLGraphBuilder(context);
    });

    promise_test(async () => {
      await testGemm(isSync,
        {
          shape: [4, 3],
          data: [
            0.16255096,
            0.36969426,
            0.86049074,
            0.52583617,
            0.40931734,
            0.5978712,
            0.02344302,
            0.22055508,
            0.45481342,
            0.70314133,
            0.7205724,
            0.3864092,
          ],
        },
        {
          shape: [5, 4],
          data: [
            0.51755,    0.9102891,  0.28687012, 0.88691926, 0.8710911,
            0.70967263, 0.7630267,  0.5303827,  0.19783545, 0.03771181,
            0.9599521,  0.9786202,  0.64332396, 0.05995055, 0.28637242,
            0.27146435, 0.89837885, 0.25250614, 0.71064854, 0.6231573,
          ],
        },
        {
          shape: [3, 5],
          data: [
            0.5243318683310813,
            0.557397912385277,
            0.528117080331477,
            0.27080579384162223,
            0.4888170726819199,
            0.5426185448391568,
            0.6217472531769015,
            0.5888327516148626,
            0.31766935679671005,
            0.565719856634743,
            0.5917375902862806,
            0.762459989982706,
            0.5893491460226568,
            0.3935235504287967,
            0.677412680257146,
          ],
        },
        {
          shape: [1, 5],
          data: [
            0.645844,
            0.94571555,
            0.9641909,
            0.53538203,
            0.87259406,
          ],
        },
        {alpha: 0.25, beta: 0.35, aTranspose: true, bTranspose: true});
    }, `gemm all attributes  / ${deviceType} / ${executionType}`);

    promise_test(async () => {
      await testGemm(isSync,
        {
          shape: [3, 5],
          data: [
            0.6454119,
            0.3664521,
            0.9339664,
            0.80538565,
            0.95667505,
            0.88069373,
            0.9214904,
            0.36922687,
            0.14497812,
            0.9269842,
            0.35244322,
            0.8430814,
            0.8758174,
            0.72640723,
            0.54108346,
          ],
        },
        {
          shape: [5, 4],
          data: [
            0.63330984, 0.35902178, 0.66004074, 0.55209464, 0.61517054,
            0.9752662,  0.7728582,  0.6539411,  0.7348231,  0.16676156,
            0.02067508, 0.8232157,  0.8965447,  0.13730305, 0.84798694,
            0.5877349,  0.59452033, 0.77880573, 0.74310994, 0.30480564,
          ],
        },
        {
          shape: [3, 4],
          data: [
            1.3056516655501957,
            0.8002504434655275,
            1.061197370189373,
            1.0648877745287364,
            1.038516251507783,
            1.0091530323988844,
            1.0564498368939703,
            0.880269401543591,
            1.1791785627830518,
            0.8079765443192164,
            0.9601925967309116,
            1.029377197893551,
          ],
        },
        undefined, {alpha: 0.5});
    }, `gemm alpha  / ${deviceType} / ${executionType}`);

    promise_test(async () => {
      await testGemm(isSync,
        {
          shape: [2, 7],
          data: [
            0.49310637,
            0.90337706,
            0.48412615,
            0.12574232,
            0.46357006,
            0.19181924,
            0.35951078,
            0.6291139,
            0.6532259,
            0.5328194,
            0.34455,
            0.30500737,
            0.42374912,
            0.5333988,
          ],
        },
        {
          shape: [7, 4],
          data: [
            0.09745993, 0.15800808, 0.8296135,  0.32482183, 0.17396742,
            0.8128901,  0.57767284, 0.5426502,  0.3885252,  0.14400595,
            0.4086032,  0.07829365, 0.02829663, 0.68851817, 0.08823209,
            0.99632514, 0.5235559,  0.01747696, 0.13607074, 0.93223673,
            0.6470155,  0.9115019,  0.8971734,  0.8677906,  0.31736255,
            0.3187993,  0.5536664,  0.7935204,
          ],
        },
        {
          shape: [2, 4],
          data: [
            1.0496741612243639,
            1.36938856972795,
            1.7876274752838266,
            2.092117621875701,
            1.1667527091648682,
            1.6092673496321952,
            2.0779392344028675,
            2.4137995216249193,
          ],
        },
        {
          shape: [1, 4],
          data: [0.34378892, 0.20655482, 0.4271018, 0.78929764],
        },
        {beta: 0.5});
    }, `gemm beta  / ${deviceType} / ${executionType}`);

    promise_test(async () => {
      await testGemm(isSync,
        {
          shape: [3, 6],
          data: [
            0.26634723,
            0.6047771,
            0.55068576,
            0.9991724,
            0.67497027,
            0.92930806,
            0.2860512,
            0.6988867,
            0.89526093,
            0.3717174,
            0.19019075,
            0.4499846,
            0.51885146,
            0.4031741,
            0.6269008,
            0.27176815,
            0.8668971,
            0.5799844,
          ],
        },
        {
          shape: [6, 4],
          data: [
            0.9380275,  0.12814452, 0.6522671,  0.6646124,  0.17909846,
            0.901151,   0.3000952,  0.326868,   0.3915249,  0.45130828,
            0.581687,   0.9738232,  0.38067418, 0.9359868,  0.4762245,
            0.07865977, 0.9511043,  0.7688367,  0.88563424, 0.7623637,
            0.04992711, 0.2871258,  0.09989859, 0.78412026,
          ],
        },
        {
          shape: [3, 4],
          data: [
            2.1861426866108147,
            2.8305439820330496,
            1.9655125113296532,
            2.7772129031129267,
            1.739566756989102,
            1.8645036093741494,
            1.835017045627564,
            2.620343856710825,
            2.358861093402937,
            2.009745597962233,
            2.069979204417261,
            3.0899011883030036,
          ],
        },
        {
          shape: [3, 4],
          data: [
            0.5436559,
            0.2819061,
            0.1235218,
            0.5443856,
            0.6506955,
            0.1706562,
            0.52752787,
            0.80288535,
            0.5975874,
            0.20960917,
            0.29078278,
            0.8657452,
          ],
        });
    }, `gemm bias  / ${deviceType} / ${executionType}`);

    promise_test(async () => {
      await testGemm(isSync,
        {
          shape: [2, 10],
          data: [
            0.97596496, 0.47531518, 0.7147315,  0.14236908, 0.06151228,
            0.05889508, 0.3534669,  0.31915423, 0.61336106, 0.5946216,
            0.21969128, 0.7347848,  0.4087221,  0.00412959, 0.77303815,
            0.6495765,  0.3174799,  0.62841094, 0.7002717,  0.63384914,
          ],
        },
        {
          shape: [10, 3],
          data: [
            0.51739925, 0.25108355, 0.31373033, 0.6488124,  0.9777175,
            0.13308926, 0.47903556, 0.23692878, 0.0822504,  0.3080891,
            0.51966125, 0.969734,   0.6691261,  0.59346807, 0.7651862,
            0.48655444, 0.48373327, 0.2799068,  0.35760838, 0.19906454,
            0.3612888,  0.11448191, 0.19188708, 0.00769753, 0.3161914,
            0.323555,   0.17573832, 0.79587144, 0.91238266, 0.5517277,
          ],
        },
        {
          shape: [2, 3],
          data: [
            2.099535174427932,
            1.8906747304468192,
            1.1958703062765146,
            2.5321421018503787,
            2.6342243688257088,
            1.5699927914492209,
          ],
        });
    }, `gemm no bias  / ${deviceType} / ${executionType}`);

    promise_test(async () => {
      await testGemm(isSync,
        {
          shape: [2, 3],
          data: [
            0.41595492,
            0.7063231,
            0.3784654,
            0.3524597,
            0.41936764,
            0.08190536,
          ],
        },
        {
          shape: [3, 4],
          data: [
            0.38356313,
            0.92939967,
            0.06164686,
            0.09034675,
            0.34704673,
            0.9492532,
            0.7738587,
            0.93576515,
            0.49937814,
            0.38543963,
            0.02364575,
            0.80216527,
          ],
        },
        {
          shape: [2, 4],
          data: [
            3.7336694407389186,
            4.342943392035599,
            3.721185688897571,
            4.142124516565133,
            3.461632460193509,
            3.897231574768164,
            3.48819604416023,
            3.6299748461695684,
          ],
        },
        3.14);
    }, `gemm scalar bias  / ${deviceType} / ${executionType}`);

    promise_test(async () => {
      await testGemm(isSync,
        {
          shape: [3, 7],
          data: [
            0.96122783, 0.7414551,  0.22178489, 0.23116009, 0.19249596,
            0.860125,   0.24145897, 0.43657154, 0.20278022, 0.01261093,
            0.526355,   0.94473153, 0.59416693, 0.5121616,  0.93981737,
            0.9942615,  0.46400633, 0.40644044, 0.43731472, 0.22579351,
            0.6787937,
          ],
        },
        {
          shape: [7, 3],
          data: [
            0.1004637,  0.31921694, 0.7323029,  0.05150159, 0.9162225,
            0.89180815, 0.00931315, 0.3568885,  0.9506084,  0.04976705,
            0.6065987,  0.99300903, 0.29279497, 0.29296732, 0.38377914,
            0.80959237, 0.5812153,  0.34052548, 0.2931774,  0.12963536,
            0.58294684,
          ],
        },
        {
          shape: [3, 3],
          data: [
            1.7498733917245672,
            2.5712126946215443,
            3.091094720699889,
            1.7664618383456954,
            2.115494714166447,
            2.676713501071726,
            1.4580698060088526,
            2.748510677662516,
            3.838076489432427,
          ],
        },
        {shape: [1], data: [0.7780463]});
    }, `gemm broadcasting bias  / ${deviceType} / ${executionType}`);

    promise_test(async () => {
      await testGemm(isSync,
        {
          shape: [6, 3],
          data: [
            0.2714853,
            0.0877158,
            0.31404206,
            0.2387523,
            0.25758955,
            0.37354097,
            0.6452827,
            0.8840964,
            0.14744024,
            0.65488476,
            0.35878596,
            0.3690042,
            0.4229308,
            0.40953776,
            0.85461134,
            0.7056307,
            0.17941293,
            0.4431382,
          ],
        },
        {
          shape: [6, 4],
          data: [
            0.09183464, 0.8638833,  0.9302645,  0.06964016, 0.43232033,
            0.7631357,  0.5690705,  0.57837325, 0.17691018, 0.77424425,
            0.8207884,  0.429646,   0.31379876, 0.29592493, 0.10828935,
            0.00203794, 0.9140249,  0.31878716, 0.11819135, 0.6350557,
            0.7605846,  0.40116578, 0.32365775, 0.07651691,
          ],
        },
        {
          shape: [3, 4],
          data: [
            1.3710694580379748,
            1.5280349660791157,
            1.2673472343664909,
            0.7581492662083144,
            0.8991952125197271,
            1.2655619679904546,
            1.0991664828167445,
            0.809478525550666,
            1.4503861699104,
            1.2299214444777435,
            0.9101225708947001,
            0.8786485304251702,
          ],
        },
        0.0, {aTranspose: true});
    }, `gemm aTranpose  / ${deviceType} / ${executionType}`);

    promise_test(async () => {
      await testGemm(isSync,
        {
          shape: [3, 6],
          data: [
            0.4520783,
            0.25709572,
            0.28996432,
            0.03766193,
            0.0546827,
            0.46305302,
            0.91171485,
            0.48380807,
            0.09058774,
            0.6646215,
            0.35773644,
            0.03604647,
            0.21229707,
            0.18758385,
            0.01589681,
            0.9606218,
            0.08803706,
            0.18099776,
          ],
        },
        {
          shape: [4, 6],
          data: [
            0.1482661, 0.27676222, 0.10893039, 0.8347901,  0.7146212,
            0.7316929, 0.97991717, 0.97123116, 0.69798464, 0.8436566,
            0.9630883, 0.23252074, 0.09898344, 0.08882044, 0.90780985,
            0.7116153, 0.5819304,  0.6742051,  0.5233705,  0.5594687,
            0.963364,  0.1351259,  0.8119938,  0.13756031,
          ],
        },
        {
          shape: [3, 4],
          data: [
            0.5790980251807042,
            1.0871967394943738,
            0.7016311248544318,
            0.7729714738584772,
            1.11578439712886,
            2.340149006498089,
            0.9208884121099968,
            1.2203550096802216,
            1.0823897209392859,
            1.3386246706912768,
            0.9089606799007333,
            0.45756027099352364,
          ],
        },
        0.0, {bTranspose: true});
    }, `gemm bTranspose  / ${deviceType} / ${executionType}`);
  });
});