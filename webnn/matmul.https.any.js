// META: title=test WebNN API matmul operation
// META: global=window,dedicatedworker
// META: script=./resources/utils.js
// META: timeout=long

'use strict';

// https://webmachinelearning.github.io/webnn/#api-mlgraphbuilder-matmul

let context;
let builder;

async function testMatmul(syncFlag, A, B, expected) {
  const a = builder.input('a', {type: 'float32', dimensions: A.shape});
  const b = builder.constant({type: 'float32', dimensions: B.shape}, new Float32Array(B.data));
  const c = builder.matmul(a, b);
  const inputs = {'a': new Float32Array(A.data)};
  const outputs = {'c': new Float32Array(sizeOfShape(expected.shape))};
  let graph;

  if (syncFlag) {
    graph = builder.build({c});
    context.compute(graph, inputs, outputs);
  } else {
    graph = await builder.buildAsync({c});
    await context.computeAsync(graph, inputs, outputs);
  }

  assert_array_approx_equals_ulp(outputs.c, expected.data, ULPTolerance.float32.matmul, 'float32');
}

ExecutionArray.forEach(executionType => {
  const isSync = executionType === 'sync';
  if (self.GLOBAL.isWindow() && isSync) {
    return;
  }

  const targetDeviceTypeArray = getTargetDeviceTypeArray();
  targetDeviceTypeArray.forEach(deviceType => {
    promise_setup(async () => {
      await navigator.ml.createContext({deviceType}).then((ret) => context = ret);
      builder = new MLGraphBuilder(context);
    });

    promise_test(async () => {
      await testMatmul(isSync,
        {shape: [4], data: [0.9025404, 0.89538723, 0.16789329, 0.7440875]},
        {shape: [4], data: [0.8782074, 0.22533207, 0.7134056, 0.04190519]},
        {shape: [], data: [1.145334257418975]});
    }, `matmul 1d  / ${deviceType} / ${executionType}`);

    promise_test(async () => {
      await testMatmul(isSync,
        {
          shape: [4], data: [0.1309212, 0.9090703, 0.62183434, 0.9195683]}, {
          shape: [4, 3],
          data: [
            0.3093976,
            -1.2924036,
            -0.64339244,
            1.1423386,
            1.5052135,
            1.8182521,
            -1.825652,
            -0.39694095,
            -0.90111053,
            0.7807154,
            -1.9163561,
            -0.13988003,
          ],
        },
        {
          shape: [1, 3],
          data: [
            0.6616408255448397,
            -0.8099099769211229,
            0.8797145586262527,
        ]});
    }, `matmul 1dx2d  / ${deviceType} / ${executionType}`);

    promise_test(async () => {
      await testMatmul(isSync,
        {
          shape: [3, 4],
          data: [
            0.3582649,
            0.83665735,
            0.30253866,
            0.6446781,
            0.4684662,
            0.94761264,
            0.4122941,
            0.6787481,
            0.15072346,
            0.2820577,
            0.67296237,
            0.3856028,
          ],
        },
        {shape: [4], data: [0.25528687, 0.2126722, 0.26320502, 0.8297401]},
        {
          shape: [3, 1],
          data: [
            0.8839390494404162,
            0.992826528000594,
            0.5955407318122876,
          ]});
    }, `matmul 2dx1d  / ${deviceType} / ${executionType}`);

    promise_test(async () => {
      await testMatmul(isSync,
        {
          shape: [3, 4],
          data: [
            0.9602246,
            0.97682184,
            -0.33201018,
            0.8248904,
            0.40872088,
            0.18995902,
            0.69355214,
            -0.37210146,
            0.18104352,
            3.270753,
            -0.803097,
            -0.7268995,
          ],
        },
        {
          shape: [4, 3],
          data: [
            0.17467105,
            -1.2045133,
            -0.02621938,
            0.6096196,
            1.4499376,
            1.3465316,
            0.03289436,
            1.0754977,
            -0.61485314,
            0.94857556,
            -0.36462623,
            1.402278,
          ],
        },
        {
          shape: [3, 3],
          data: [
            1.5347627892239333,
            -0.39812544905177394,
            2.651008143473561,
            -0.14295794996907119,
            0.6647106735468218,
            -0.703152987090222,
            1.3096017351837559,
            3.9256360751909685,
            3.8738969565609622,
          ],
        });
    }, `matmul 2d  / ${deviceType} / ${executionType}`);

    promise_test(async () => {
      await testMatmul(isSync,
        {
          shape: [2, 3, 4],
          data: [
            0.19521078,  0.11637875, 0.54684865,  0.13257395, -0.05654722,
            -0.64351636, -1.0019655, -1.6156989,  0.01625126, 1.2386297,
            -0.1242797,  0.40350053, -0.5883816,  0.93452644, -0.01409106,
            -0.7825521,  -1.2281458, -1.2388189,  0.7644939,  -0.8567167,
            0.3942727,   -0.772506,  -0.06412488, -0.9848109,
          ],
        },
        {
          shape: [2, 4, 3],
          data: [
            -2.7142005,  0.41909233,  0.80572236,  0.19983047, -1.9361104,
            1.1919757,   0.61684674,  0.23732206,  0.74679494, 0.4595843,
            -0.90667343, 0.7676448,   0.48643762,  0.41120672, 1.1319419,
            1.9692143,   -0.44463134, 0.17005378,  1.1589569,  -0.4333597,
            -0.47976026, 0.01067371,  -0.79455626, -1.4024538,
          ],
        },
        {
          shape: [2, 3, 3],
          data: [
            -0.10833446333599143,
            -0.13393279743161207,
            0.8061598404542069,
            -1.3357226841086192,
            2.4493429579826187,
            -2.801162847627581,
            0.31218775792583,
            -2.7866505894621443,
            1.7064441398054897,
            1.5293882188296952,
            -0.029578043761553485,
            0.5971594643551588,
            -2.1600450781503135,
            0.39520467130026193,
            -0.7661237278034159,
            -1.414270346305937,
            1.3158847659611541,
            1.7268425818711388,
          ],
        });
    }, `matmul 3d  / ${deviceType} / ${executionType}`);

    promise_test(async () => {
      await testMatmul(isSync,
        {
          shape: [2, 3, 4],
          data: [
            -0.57675153, -0.40231872, 0.10705414,  -0.66516143, 0.3206562,
            0.43695804,  -1.8614748,  0.77510875,  -1.2424866,  -0.58930343,
            0.40949076,  0.5517746,   0.09809388,  0.5084747,   0.76594603,
            0.8050488,   -0.03979152, 2.4019558,   -0.54937273, -0.1696853,
            -1.223669,   1.0791223,   -0.61921734, 2.1074235,
          ],
        },
        {
          shape: [4, 3],
          data: [
            -0.38534147,
            -0.18395364,
            -2.548874,
            0.4525641,
            -0.41875792,
            0.57480955,
            -0.41603103,
            0.6973883,
            0.9531734,
            1.3292471,
            -1.003955,
            -0.7639869,
          ],
        },
        {
          shape: [2, 3, 3],
          data: [
            -0.8885304730243201,
            1.0170201418415437,
            1.849026114390587,
            1.878931727122919,
            -2.3183105665073347,
            -2.9326257919832135,
            0.7751679607198163,
            0.20695260775599766,
            2.7969716845016883,
            0.9437692220342353,
            -0.5050435022828981,
            0.15727981777314692,
            1.1053746974552965,
            -1.211287928674362,
            1.0880805766675583,
            4.01880262734377,
            -2.774385931084078,
            1.539002458305059,
          ],
        });
    }, `matmul 3dx2d  / ${deviceType} / ${executionType}`);

    promise_test(async () => {
      await testMatmul(isSync,
        {
          shape: [1, 3, 4],
          data: [
            0.25500464,
            -1.105212,
            -0.5368534,
            -0.01583702,
            0.9875369,
            1.3744136,
            0.61079186,
            0.74018836,
            -0.56111795,
            -0.16432828,
            1.3176169,
            -0.249416,
          ],
        },
        {
          shape: [4, 3],
          data: [
            0.2545374,
            -1.6150205,
            -0.64508885,
            -0.3454305,
            0.38700557,
            1.3147515,
            -0.3379386,
            1.1804152,
            1.9414345,
            -1.5912915,
            0.40443325,
            -0.23596671,
          ],
        },
        {
          shape: [1, 3, 3],
          data: [
            0.653306953532106,
            -1.4796758522265552,
            -2.65610848747696,
            -1.607664893851476,
            -0.04264183969545593,
            2.181115876300509,
            -0.13444155392012996,
            2.2970839255543356,
            2.7628408608418473,
          ],
        });
    }, `matmul 3dx2d should be 3d  / ${deviceType} / ${executionType}`);

    promise_test(async () => {
      await testMatmul(isSync,
        {
          shape: [1, 2, 3, 4],
          data: [
            -0.8074054, -0.72524256, 0.4510249,  1.6203358,   1.9851393,
            0.501528,   1.3975041,   -2.3231244, 0.70866925,  0.24667543,
            -0.6271161, -0.9634111,  -0.5911732, -0.09888726, -1.0926677,
            0.47262478, 0.6141726,   -0.634484,  -0.07425678, -1.2638812,
            -1.1002079, -1.5324054,  -1.1643038, -0.05644368,
          ],
        },
        {
          shape: [1, 2, 4, 3],
          data: [
            -0.45605758, -0.43318668, 0.61509126, -2.2228749,  0.50257015,
            -0.29311436, -0.64561933, -0.6439757, 1.6211574,   -0.28852704,
            -0.46247238, 0.5082442,   1.2357981,  -0.82043344, -0.926581,
            -0.8955289,  0.74586314,  -0.8022598, -0.5360306,  -0.08719682,
            0.72717273,  1.1277325,   2.0261378,  -1.4311641,
          ],
        },
        {
          shape: [1, 2, 3, 3],
          data: [
            1.221645749907327,
            -1.0545376270456461,
            1.2706596306239777,
            -2.252143281998571,
            -0.4334607112616218,
            2.1588963856372976,
            -0.188674175668765,
            0.6663841820450125,
            -1.1427098588511797,
            0.47668332938386415,
            1.4641419805936096,
            -0.8438586440388712,
            -0.05832390830187206,
            -3.531448486441424,
            1.6947642397339107,
            0.57312758193175,
            -0.25315643602996796,
            1.4829491816053335,
          ],
        });
    }, `matmul 4d  / ${deviceType} / ${executionType}`);

    promise_test(async () => {
      await testMatmul(isSync,
        {
          shape: [1, 2, 3, 4],
          data: [
            -0.40162078, -0.5607968, -1.4350457,  -0.22855183, -0.1357853,
            -1.3434876,  1.0602195,  -0.17137937, 0.44751146,  0.78427273,
            -0.49435133, -0.9062699, -0.6109297,  0.645001,    0.6632162,
            0.903104,    2.4085212,  0.7805757,   -0.9099179,  -0.6195976,
            0.38710263,  0.5102191,  -0.03610202, 1.2280966,
          ],
        },
        {
          shape: [4, 3],
          data: [
            0.01829041,
            -0.73948264,
            -0.95898634,
            -0.5105271,
            2.1705306,
            1.2495605,
            -1.9865801,
            -0.58367056,
            -0.80371356,
            -0.583849,
            -1.2323712,
            1.3314632,
          ],
        },
        {
          shape: [1, 2, 3, 3],
          data: [
            3.2632291428668005,
            0.1990196002350671,
            0.5334566494457813,
            -1.3227480270318333,
            -3.2232859838291446,
            -2.6288509024476023,
            1.1189859750587483,
            2.7767602451442084,
            -0.2585093062909366,
            -2.185273116934897,
            0.35170718388113653,
            2.061254897681926,
            1.814924023726412,
            1.2078703550705958,
            -1.4280204169121542,
            -0.8987038289844296,
            -0.6712086999562717,
            1.9305046113199869,
          ],
        });
    }, `matmul 4dx2d  / ${deviceType} / ${executionType}`);
  });
});